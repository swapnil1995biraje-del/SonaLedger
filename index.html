<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Sona â€” Gold Ledger</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --gold: #C9A84C; --gold-light: #F0DC9A; --gold-dark: #8B6914;
  --cream: #FAF7F0; --dark: #1A1208; --muted: #8A7A5A;
  --surface: #FFF8E8; --border: #EAD9A0;
  --red: #D32F2F; --green: #2E7D32; --orange: #E65100;
  --shadow: 0 2px 16px rgba(139,105,20,0.13);
  --radius: 16px; --tab-h: 72px; --top-h: 64px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--dark); height: 100%; width: 100%; overflow: hidden; }

/* â”€â”€ AUTH SCREEN â”€â”€ */
.auth-screen {
  position: fixed; inset: 0; background: var(--dark);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 32px 24px; z-index: 1000;
}
.auth-screen.hidden { display: none; }
.auth-logo { font-family: 'Cormorant Garamond', serif; font-size: 48px; font-weight: 700; color: var(--gold); letter-spacing: 4px; margin-bottom: 6px; }
.auth-tagline { font-size: 13px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 48px; }
.auth-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(201,168,76,0.2); border-radius: 24px; padding: 28px 24px; width: 100%; max-width: 380px; }
.auth-card h2 { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: white; margin-bottom: 6px; }
.auth-card p { font-size: 13px; color: var(--muted); margin-bottom: 24px; line-height: 1.5; }
.auth-input { width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 1.5px solid rgba(201,168,76,0.3); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 16px; color: white; outline: none; margin-bottom: 14px; }
.auth-input::placeholder { color: var(--muted); }
.auth-input:focus { border-color: var(--gold); }
.auth-btn { width: 100%; padding: 16px; background: var(--gold); border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 700; color: var(--dark); cursor: pointer; transition: all 0.15s; }
.auth-btn:active { transform: scale(0.97); }
.auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.auth-btn-outline { background: transparent; border: 1.5px solid rgba(201,168,76,0.4); color: var(--gold); margin-top: 10px; }
.auth-err { color: #FF8A80; font-size: 13px; margin-bottom: 12px; text-align: center; }
.auth-success { color: #69F0AE; font-size: 13px; margin-bottom: 12px; text-align: center; }
.otp-inputs { display: flex; gap: 10px; margin-bottom: 16px; justify-content: center; }
.otp-box { width: 46px; height: 54px; background: rgba(255,255,255,0.08); border: 1.5px solid rgba(201,168,76,0.3); border-radius: 12px; font-size: 22px; font-weight: 700; color: white; text-align: center; outline: none; font-family: 'DM Sans', sans-serif; }
.otp-box:focus { border-color: var(--gold); background: rgba(201,168,76,0.1); }

/* â”€â”€ LOADING â”€â”€ */
.loading-overlay { position: fixed; inset: 0; background: rgba(26,18,8,0.7); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
.loading-overlay.hidden { display: none; }
.spinner { width: 40px; height: 40px; border: 3px solid rgba(201,168,76,0.3); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ TOAST â”€â”€ */
.toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-80px); background: var(--dark); color: white; padding: 12px 20px; border-radius: 12px; font-size: 14px; z-index: 9999; transition: transform 0.3s; border: 1px solid rgba(201,168,76,0.3); max-width: 320px; text-align: center; }
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { border-color: rgba(46,125,50,0.5); }
.toast.error { border-color: rgba(211,47,47,0.5); }

/* â”€â”€ MAIN APP â”€â”€ */
.app { display: flex; flex-direction: column; height: 100dvh; width: 100%; max-width: 430px; margin: 0 auto; background: var(--cream); overflow: hidden; }
.topbar { height: var(--top-h); background: var(--dark); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; z-index: 10; }
.topbar-logo { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 700; color: var(--gold); letter-spacing: 3px; }
.topbar-sub { font-size: 10px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
.topbar-right { display: flex; gap: 8px; align-items: center; }
.icon-btn { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.08); border: none; cursor: pointer; font-size: 20px; position: relative; color: white; }
.notif-dot { position: absolute; top: 8px; right: 8px; width: 9px; height: 9px; border-radius: 50%; background: var(--red); border: 2px solid var(--dark); }
.scroll-area { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; padding-bottom: calc(var(--tab-h) + 16px); }
.tabbar { height: var(--tab-h); background: white; border-top: 1px solid var(--border); display: flex; align-items: stretch; flex-shrink: 0; box-shadow: 0 -4px 20px rgba(139,105,20,0.1); }
.tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; cursor: pointer; padding-bottom: env(safe-area-inset-bottom, 0); position: relative; border: none; background: none; transition: all 0.18s; }
.tab-icon { font-size: 26px; line-height: 1; transition: transform 0.18s; }
.tab-label { font-size: 11px; font-weight: 500; color: var(--muted); }
.tab.active .tab-icon { transform: translateY(-2px); }
.tab.active .tab-label { color: var(--gold-dark); font-weight: 600; }
.tab-active-bar { position: absolute; bottom: 0; left: 20%; right: 20%; height: 3px; background: var(--gold); border-radius: 3px 3px 0 0; opacity: 0; transition: opacity 0.18s; }
.tab.active .tab-active-bar { opacity: 1; }
.tab-badge { position: absolute; top: 6px; right: calc(50% - 20px); background: var(--red); color: white; font-size: 10px; font-weight: 700; border-radius: 10px; padding: 1px 5px; min-width: 18px; text-align: center; line-height: 16px; }
.fab { position: fixed; bottom: calc(var(--tab-h) + 16px); right: calc(50% - 215px + 16px); width: 58px; height: 58px; background: var(--gold); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--dark); box-shadow: 0 6px 24px rgba(201,168,76,0.45); border: none; cursor: pointer; z-index: 50; transition: transform 0.15s; }
.fab:active { transform: scale(0.93); }
.page { display: none; }
.page.active { display: block; }
.section-label { padding: 20px 20px 10px; font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

/* â”€â”€ STATS â”€â”€ */
.stats-scroll { display: flex; gap: 12px; padding: 16px 20px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
.stats-scroll::-webkit-scrollbar { display: none; }
.stat-card { border-radius: var(--radius); padding: 18px 20px; min-width: 150px; flex-shrink: 0; }
.stat-card.gold-card { background: linear-gradient(135deg, #2D2210, #1A1208); border: 1px solid rgba(201,168,76,0.3); }
.stat-card.red-card { background: linear-gradient(135deg, #3B1010, #1A1208); border: 1px solid rgba(211,47,47,0.3); }
.stat-card.green-card { background: linear-gradient(135deg, #0D2B14, #1A1208); border: 1px solid rgba(46,125,50,0.3); }
.stat-card.blue-card { background: linear-gradient(135deg, #0D1E2B, #1A1208); border: 1px solid rgba(41,128,185,0.3); }
.stat-emoji { font-size: 28px; margin-bottom: 10px; display: block; }
.stat-val { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 700; color: white; line-height: 1; }
.stat-lbl { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px; }

/* â”€â”€ ALERTS â”€â”€ */
.alert-banner { margin: 0 16px 10px; border-radius: 14px; padding: 14px 18px; display: flex; align-items: center; gap: 14px; }
.alert-banner.alert-red { background: #FFF0F0; border: 1.5px solid #FFCDD2; }
.alert-banner.alert-amber { background: #FFFDE7; border: 1.5px solid #FFE082; }
.alert-big { font-family: 'Cormorant Garamond', serif; font-size: 32px; font-weight: 700; line-height: 1; }
.alert-red .alert-big { color: var(--red); }
.alert-amber .alert-big { color: #E65100; }
.alert-text strong { font-size: 15px; display: block; color: var(--dark); }
.alert-text span { font-size: 12px; color: var(--muted); }

/* â”€â”€ TXN CARDS â”€â”€ */
.txn-list { padding: 0 16px; }
.txn-card { background: white; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 12px; overflow: hidden; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.15s; }
.txn-card:active { transform: scale(0.98); }
.txn-card-top { padding: 16px 16px 12px; display: flex; justify-content: space-between; align-items: flex-start; }
.txn-party { font-size: 18px; font-weight: 600; color: var(--dark); }
.txn-phone { font-size: 13px; color: var(--muted); margin-top: 2px; }
.txn-type-badge { font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; flex-shrink: 0; margin-left: 10px; }
.badge-gold-credit { background: #FFF3CD; color: #8B6914; }
.badge-cash-loan { background: #E8F5E9; color: #2E7D32; }
.badge-gold-taken { background: #E3F2FD; color: #1565C0; }
.badge-wholesale { background: #F3E5F5; color: #6A1B9A; }
.txn-card-mid { padding: 0 16px 14px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; border-bottom: 1px solid var(--border); }
.txn-metric label { font-size: 11px; color: var(--muted); display: block; text-transform: uppercase; letter-spacing: 0.5px; }
.txn-metric span { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 700; color: var(--dark); display: block; line-height: 1.2; }
.txn-metric span.amt { color: var(--gold-dark); }
.txn-card-bot { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; }
.txn-date-row { font-size: 12px; color: var(--muted); }
.txn-date-row strong { color: var(--dark); font-weight: 500; }
.status-pill { font-size: 11px; font-weight: 600; padding: 4px 12px; border-radius: 20px; }
.pill-open { background: #FFF3E0; color: #E65100; }
.pill-closed { background: #E8F5E9; color: #2E7D32; }
.pill-overdue { background: #FFEBEE; color: #B71C1C; }
.txn-overdue-bar { height: 4px; background: linear-gradient(90deg, var(--red), #FF8A80); }
.txn-open-bar { height: 4px; background: linear-gradient(90deg, var(--gold), var(--gold-light)); }
.txn-closed-bar { height: 4px; background: linear-gradient(90deg, #27AE60, #81C784); }

/* â”€â”€ FILTERS & SEARCH â”€â”€ */
.filter-strip { display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto; scrollbar-width: none; }
.filter-strip::-webkit-scrollbar { display: none; }
.chip { padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500; border: 1.5px solid var(--border); background: white; color: var(--muted); cursor: pointer; white-space: nowrap; flex-shrink: 0; transition: all 0.15s; }
.chip.active { background: var(--gold); color: var(--dark); border-color: var(--gold); font-weight: 600; }
.search-wrap { padding: 12px 16px 0; }
.search-box { display: flex; align-items: center; gap: 10px; background: white; border: 1.5px solid var(--border); border-radius: 14px; padding: 12px 16px; }
.search-box input { flex: 1; border: none; background: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 15px; color: var(--dark); }
.search-box input::placeholder { color: var(--muted); }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state { padding: 60px 20px; text-align: center; }
.empty-icon { font-size: 56px; display: block; margin-bottom: 12px; opacity: 0.35; }
.empty-state p { font-size: 15px; color: var(--muted); line-height: 1.6; }

/* â”€â”€ REMINDERS â”€â”€ */
.reminder-group-label { padding: 16px 20px 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.reminder-group-label.red { color: var(--red); }
.reminder-group-label.amber { color: var(--orange); }
.reminder-group-label.mgreen { color: var(--green); }
.reminder-card { background: white; border-radius: var(--radius); border: 1.5px solid var(--border); margin: 0 16px 10px; padding: 16px; display: flex; align-items: center; gap: 14px; cursor: pointer; box-shadow: var(--shadow); }
.reminder-card.rem-overdue { border-color: #FFCDD2; background: #FFFAFA; }
.reminder-card.rem-today { border-color: #FFE082; background: #FFFDF0; }
.rem-icon { font-size: 30px; flex-shrink: 0; }
.rem-info { flex: 1; min-width: 0; }
.rem-name { font-size: 16px; font-weight: 600; color: var(--dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rem-sub { font-size: 13px; color: var(--muted); margin-top: 2px; }
.rem-date { font-size: 13px; font-weight: 600; text-align: right; flex-shrink: 0; }
.rem-date.red { color: var(--red); }
.rem-date.amber { color: var(--orange); }
.rem-date.mgreen { color: var(--green); }

/* â”€â”€ PARTIES â”€â”€ */
.party-card { background: white; border-radius: var(--radius); border: 1px solid var(--border); margin: 0 16px 12px; padding: 16px; box-shadow: var(--shadow); cursor: pointer; }
.party-card-top { display: flex; align-items: center; gap: 14px; margin-bottom: 12px; }
.party-avatar { width: 50px; height: 50px; border-radius: 14px; background: var(--dark); display: flex; align-items: center; justify-content: center; font-family: 'Cormorant Garamond', serif; font-size: 22px; color: var(--gold); font-weight: 700; flex-shrink: 0; }
.party-name { font-size: 17px; font-weight: 600; color: var(--dark); }
.party-phone { font-size: 13px; color: var(--muted); margin-top: 2px; }
.party-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.p-stat { background: var(--surface); border-radius: 10px; padding: 10px 12px; }
.p-stat label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; }
.p-stat span { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 700; color: var(--dark); display: block; }

/* â”€â”€ BOTTOM SHEET â”€â”€ */
.sheet-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; backdrop-filter: blur(3px); }
.sheet-overlay.open { display: block; }
.bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; max-width: 430px; margin: 0 auto; background: white; border-radius: 24px 24px 0 0; z-index: 301; max-height: 92dvh; overflow-y: auto; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,0.72,0,1); }
.bottom-sheet.open { transform: translateY(0); }
.sheet-handle { width: 40px; height: 5px; border-radius: 3px; background: var(--border); margin: 12px auto 4px; }
.sheet-header { padding: 8px 20px 16px; border-bottom: 1px solid var(--border); }
.sheet-party { font-size: 22px; font-weight: 700; color: var(--dark); }
.sheet-phone { font-size: 14px; color: var(--muted); margin-top: 4px; }
.sheet-badges { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
.sheet-body { padding: 16px 20px; }
.detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
.d-item label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 3px; }
.d-item span { font-size: 16px; font-weight: 600; color: var(--dark); }
.d-item span.big { font-family: 'Cormorant Garamond', serif; font-size: 24px; color: var(--gold-dark); }
.wa-row { border-radius: 12px; padding: 12px 14px; display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 14px; }
.wa-confirmed { background: #E8F5E9; color: #2E7D32; }
.wa-pending { background: #FFF3E0; color: #E65100; }
.wa-disputed { background: #FFEBEE; color: #C62828; }
.wa-icon { font-size: 22px; }
.sheet-actions { display: flex; flex-direction: column; gap: 10px; padding: 16px 20px 20px; border-top: 1px solid var(--border); }
.big-btn { width: 100%; padding: 16px; border-radius: 14px; font-family: 'DM Sans', sans-serif; font-size: 16px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
.big-btn:active { transform: scale(0.97); }
.big-btn-gold { background: var(--gold); color: var(--dark); }
.big-btn-green { background: #E8F5E9; color: var(--green); border: 1.5px solid #C8E6C9; }
.big-btn-red { background: #FFEBEE; color: var(--red); border: 1.5px solid #FFCDD2; }
.big-btn-outline { background: white; color: var(--muted); border: 1.5px solid var(--border); }
.photo-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 12px; }
.photo-thumb { width: 80px; height: 80px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; cursor: pointer; }
.notes-box { background: var(--surface); border-radius: 12px; padding: 12px 14px; font-size: 14px; color: var(--muted); margin-bottom: 12px; }

/* â”€â”€ FORM SHEET â”€â”€ */
.form-sheet { position: fixed; inset: 0; background: var(--cream); z-index: 400; overflow-y: auto; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32,0.72,0,1); max-width: 430px; margin: 0 auto; }
.form-sheet.open { transform: translateY(0); }
.form-topbar { position: sticky; top: 0; background: var(--dark); z-index: 5; padding: 0 16px; height: 56px; display: flex; align-items: center; justify-content: space-between; }
.form-title { font-family: 'Cormorant Garamond', serif; font-size: 20px; color: var(--gold); font-weight: 600; }
.close-icon-btn { background: none; border: none; font-size: 24px; color: white; cursor: pointer; padding: 8px; }
.form-body { padding: 20px 16px 100px; }
.fg { margin-bottom: 16px; }
.fg label { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; display: block; margin-bottom: 7px; }
.fg input, .fg select, .fg textarea { width: 100%; padding: 14px 16px; background: white; border: 1.5px solid var(--border); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 16px; color: var(--dark); outline: none; -webkit-appearance: none; appearance: none; transition: border-color 0.2s; }
.fg input:focus, .fg select:focus, .fg textarea:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.12); }
.fg textarea { resize: vertical; min-height: 80px; }
.fg-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.calc-chip { background: var(--dark); color: var(--gold); border-radius: 12px; padding: 14px 16px; font-size: 15px; font-weight: 600; margin-bottom: 16px; text-align: center; font-family: 'Cormorant Garamond', serif; }
.upload-zone { border: 2px dashed var(--border); border-radius: 14px; padding: 24px; text-align: center; cursor: pointer; background: white; font-size: 14px; color: var(--muted); margin-bottom: 12px; }
.upload-zone .up-icon { font-size: 36px; display: block; margin-bottom: 8px; }
.upload-zone.uploading { opacity: 0.6; pointer-events: none; }
#upload-input { display: none; }
.preview-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
.prev-img { width: 64px; height: 64px; border-radius: 10px; object-fit: cover; border: 1px solid var(--border); }
.form-save-btn { position: sticky; bottom: 0; background: white; border-top: 1px solid var(--border); z-index: 6; padding: 14px 20px 28px; }
.form-save-inner { width: 100%; padding: 16px; background: var(--gold); border-radius: 14px; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 17px; font-weight: 700; color: var(--dark); display: flex; align-items: center; justify-content: center; gap: 8px; }
.form-save-inner:disabled { opacity: 0.6; cursor: not-allowed; }
.form-save-inner:active { transform: scale(0.97); }
.divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

/* â”€â”€ WA SHEET â”€â”€ */
.wa-sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 500; display: none; align-items: flex-end; justify-content: center; }
.wa-sheet.open { display: flex; }
.wa-inner { background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; padding: 12px 20px 36px; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.wa-inner h3 { font-size: 18px; font-weight: 700; color: var(--dark); margin: 10px 0 12px; text-align: center; }
.wa-preview { background: #E7FFDB; border-radius: 14px; padding: 14px; font-size: 13px; color: #1A3A1A; line-height: 1.6; max-height: 200px; overflow-y: auto; margin-bottom: 16px; white-space: pre-line; border: 1px solid #C8F0B4; }
.wa-action-row { display: flex; gap: 10px; }
.wa-action-row button { flex: 1; }

/* â”€â”€ CLOSE DEAL SHEET â”€â”€ */
.close-sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 500; display: none; align-items: flex-end; justify-content: center; }
.close-sheet.open { display: flex; }
.close-inner { background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; padding: 12px 20px 36px; animation: slideUp 0.3s ease; }
.close-inner h3 { font-size: 18px; font-weight: 700; color: var(--green); margin: 10px 0 16px; text-align: center; }
.close-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.c-item { background: var(--surface); border-radius: 12px; padding: 12px; }
.c-item label { font-size: 11px; color: var(--muted); display: block; text-transform: uppercase; letter-spacing: 0.5px; }
.c-item span { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 700; color: var(--dark); display: block; }

/* â”€â”€ PROFILE SHEET â”€â”€ */
.profile-sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 500; display: none; align-items: flex-end; justify-content: center; }
.profile-sheet.open { display: flex; }
.profile-inner { background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; padding: 12px 20px 40px; animation: slideUp 0.3s ease; }
.profile-inner h3 { font-size: 20px; font-weight: 700; color: var(--dark); margin: 10px 0 20px; text-align: center; font-family: 'Cormorant Garamond', serif; }
.profile-email { text-align: center; color: var(--muted); font-size: 14px; margin-bottom: 20px; padding: 12px; background: var(--surface); border-radius: 12px; }
.profile-biz { font-size: 18px; font-weight: 700; color: var(--dark); text-align: center; margin-bottom: 4px; }

/* â”€â”€ SYNC INDICATOR â”€â”€ */
.sync-bar { background: var(--dark); padding: 6px 16px; text-align: center; font-size: 11px; color: var(--gold); letter-spacing: 0.5px; display: none; }
.sync-bar.show { display: block; }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- AUTH SCREEN -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="auth-screen" id="auth-screen">
  <div class="auth-logo">âœ¦ SONA</div>
  <div class="auth-tagline">Gold Ledger Â· Professional</div>

  <!-- STEP 1: Email -->
  <div class="auth-card" id="auth-step-email">
    <h2>Welcome back ğŸ™</h2>
    <p>Enter your email to receive a login code. No password needed.</p>
    <div class="auth-err" id="email-err" style="display:none"></div>
    <input class="auth-input" type="email" id="auth-email" placeholder="your@email.com" inputmode="email" autocomplete="email">
    <button class="auth-btn" id="send-otp-btn" onclick="sendOTP()">Send Login Code â†’</button>
    <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--muted)">New user? Enter your email to create an account.</div>
  </div>

  <!-- STEP 2: OTP -->
  <div class="auth-card" id="auth-step-otp" style="display:none">
    <h2>Enter the code ğŸ“§</h2>
    <p id="otp-sent-to">We sent a 6-digit code to your email.</p>
    <div class="auth-err" id="otp-err" style="display:none"></div>
    <div class="auth-success" id="otp-success" style="display:none"></div>
    <div class="otp-inputs" id="otp-inputs">
      <input class="otp-box" maxlength="1" type="text" inputmode="numeric" pattern="[0-9]">
      <input class="otp-box" maxlength="1" type="text" inputmode="numeric" pattern="[0-9]">
      <input class="otp-box" maxlength="1" type="text" inputmode="numeric" pattern="[0-9]">
      <input class="otp-box" maxlength="1" type="text" inputmode="numeric" pattern="[0-9]">
      <input class="otp-box" maxlength="1" type="text" inputmode="numeric" pattern="[0-9]">
      <input class="otp-box" maxlength="1" type="text" inputmode="numeric" pattern="[0-9]">
    </div>
    <button class="auth-btn" id="verify-otp-btn" onclick="verifyOTP()">Verify & Login</button>
    <button class="auth-btn auth-btn-outline" onclick="backToEmail()">â† Change Email</button>
  </div>

  <!-- STEP 3: Business Setup (new users) -->
  <div class="auth-card" id="auth-step-setup" style="display:none">
    <h2>Setup your business âœ¨</h2>
    <p>This is a one-time setup. Tell us about your gold business.</p>
    <div class="auth-err" id="setup-err" style="display:none"></div>
    <input class="auth-input" type="text" id="setup-bizname" placeholder="Business Name (e.g. AB Gold)">
    <input class="auth-input" type="text" id="setup-ownername" placeholder="Your Name">
    <input class="auth-input" type="tel" id="setup-phone" placeholder="Phone Number" inputmode="numeric">
    <button class="auth-btn" onclick="setupBusiness()">Start Using Sona â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MAIN APP -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app" id="main-app" style="display:none">
  <div class="topbar">
    <div>
      <div class="topbar-logo">âœ¦ SONA</div>
      <div class="topbar-sub" id="topbar-bizname">Gold Ledger</div>
    </div>
    <div class="topbar-right">
      <button class="icon-btn" onclick="showPage('reminders')">
        ğŸ””<span class="notif-dot" id="notif-dot" style="display:none"></span>
      </button>
      <button class="icon-btn" onclick="openProfile()">ğŸ‘¤</button>
    </div>
  </div>

  <div class="sync-bar" id="sync-bar">âŸ³ Syncing with cloudâ€¦</div>

  <div class="scroll-area" id="scroll-area">
    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="stats-scroll">
        <div class="stat-card gold-card"><span class="stat-emoji">âš–ï¸</span><div class="stat-val" id="s-gold">0g</div><div class="stat-lbl">Gold Outstanding</div></div>
        <div class="stat-card red-card"><span class="stat-emoji">ğŸ’°</span><div class="stat-val" id="s-cash">â‚¹0</div><div class="stat-lbl">Cash Lent Out</div></div>
        <div class="stat-card green-card"><span class="stat-emoji">ğŸ“‹</span><div class="stat-val" id="s-open">0</div><div class="stat-lbl">Open Deals</div></div>
        <div class="stat-card blue-card"><span class="stat-emoji">ğŸ¤</span><div class="stat-val" id="s-parties">0</div><div class="stat-lbl">Parties</div></div>
      </div>
      <div id="alert-overdue-banner" style="display:none" class="alert-banner alert-red">
        <div class="alert-big" id="a-overdue">0</div>
        <div class="alert-text"><strong>âš ï¸ Overdue Follow-ups</strong><span>Past due date â€” needs attention</span></div>
      </div>
      <div id="alert-upcoming-banner" style="display:none" class="alert-banner alert-amber">
        <div class="alert-big" id="a-upcoming">0</div>
        <div class="alert-text"><strong>ğŸ“… Due This Week</strong><span>Follow up soon</span></div>
      </div>
      <div class="section-label">Recent Transactions</div>
      <div class="txn-list" id="home-txn-list"></div>
    </div>

    <!-- LEDGER -->
    <div class="page" id="page-txns">
      <div class="search-wrap">
        <div class="search-box">
          <span style="font-size:18px;color:var(--muted)">ğŸ”</span>
          <input type="text" placeholder="Search name or phoneâ€¦" id="search-input" oninput="renderTxnPage()">
        </div>
      </div>
      <div class="filter-strip">
        <span class="chip active" data-f="all" onclick="setFilter('all',this)">All</span>
        <span class="chip" data-f="gold_credit" onclick="setFilter('gold_credit',this)">Gold Credit</span>
        <span class="chip" data-f="cash_loan" onclick="setFilter('cash_loan',this)">Cash Loan</span>
        <span class="chip" data-f="gold_taken" onclick="setFilter('gold_taken',this)">Gold Taken</span>
        <span class="chip" data-f="open" onclick="setFilter('open',this)">Open</span>
        <span class="chip" data-f="closed" onclick="setFilter('closed',this)">Closed</span>
        <span class="chip" data-f="overdue" onclick="setFilter('overdue',this)">Overdue ğŸ”´</span>
      </div>
      <div class="txn-list" id="txn-list"></div>
    </div>

    <!-- REMINDERS -->
    <div class="page" id="page-reminders">
      <div id="reminders-content"></div>
    </div>

    <!-- PARTIES -->
    <div class="page" id="page-parties">
      <div class="section-label">All Parties</div>
      <div id="parties-list"></div>
    </div>
  </div>

  <div class="tabbar">
    <button class="tab active" id="tab-home" onclick="showPage('home')">
      <span class="tab-icon">ğŸ </span><span class="tab-label">Home</span><div class="tab-active-bar"></div>
    </button>
    <button class="tab" id="tab-txns" onclick="showPage('txns')">
      <span class="tab-icon">ğŸ“’</span><span class="tab-label">Ledger</span><div class="tab-active-bar"></div>
    </button>
    <button class="tab" id="tab-reminders" onclick="showPage('reminders')">
      <span class="tab-icon">ğŸ””</span><span class="tab-label">Alerts</span>
      <span class="tab-badge" id="tab-badge" style="display:none">0</span>
      <div class="tab-active-bar"></div>
    </button>
    <button class="tab" id="tab-parties" onclick="showPage('parties')">
      <span class="tab-icon">ğŸ¤</span><span class="tab-label">Parties</span><div class="tab-active-bar"></div>
    </button>
  </div>
</div>

<button class="fab" onclick="openForm()" id="fab-btn" style="display:none">ï¼‹</button>

<!-- DETAIL SHEET -->
<div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottom-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-party" id="ds-party"></div>
    <div class="sheet-phone" id="ds-phone"></div>
    <div class="sheet-badges" id="ds-badges"></div>
  </div>
  <div class="sheet-body" id="ds-body"></div>
  <div class="sheet-actions" id="ds-actions"></div>
</div>

<!-- ADD FORM -->
<div class="form-sheet" id="form-sheet">
  <div class="form-topbar">
    <div class="form-title">New Transaction</div>
    <button class="close-icon-btn" onclick="closeForm()">âœ•</button>
  </div>
  <div class="form-body">
    <div class="fg"><label>Party Name *</label><input type="text" id="f-party" placeholder="e.g. Sharma Jewellers" list="party-list" autocomplete="off"><datalist id="party-list"></datalist></div>
    <div class="fg"><label>Phone Number *</label><input type="tel" id="f-phone" placeholder="e.g. 9876543210" inputmode="numeric"></div>
    <div class="fg"><label>Transaction Type *</label>
      <select id="f-type" onchange="calcAmt()">
        <option value="">â€” Select Type â€”</option>
        <option value="gold_credit">ğŸ¥‡ Gold Given on Credit</option>
        <option value="cash_loan">ğŸ’° Cash Loan (Gold Mortgage)</option>
        <option value="gold_taken">ğŸ“¥ Gold Taken from Vendor</option>
        <option value="wholesale">ğŸ“¦ Wholesale Deal</option>
      </select>
    </div>
    <div class="fg-row">
      <div class="fg"><label>Metal</label><select id="f-metal"><option value="gold">ğŸ¥‡ Gold</option><option value="silver">ğŸ¥ˆ Silver</option></select></div>
      <div class="fg"><label>Purity</label><input type="text" id="f-purity" placeholder="22K / 24K / 999"></div>
    </div>
    <div class="fg-row">
      <div class="fg"><label>Weight (grams) *</label><input type="number" id="f-weight" placeholder="e.g. 50" step="0.001" inputmode="decimal" oninput="calcAmt()"></div>
      <div class="fg"><label>Rate (â‚¹/10g) *</label><input type="number" id="f-rate" placeholder="e.g. 72000" inputmode="numeric" oninput="calcAmt()"></div>
    </div>
    <div class="calc-chip" id="calc-chip">Amount: â€”</div>
    <div class="fg"><label>Override Amount (â‚¹)</label><input type="number" id="f-amount" placeholder="Auto-calculated above" inputmode="numeric"></div>
    <div class="divider"></div>
    <div class="fg-row">
      <div class="fg"><label>Date *</label><input type="date" id="f-date"></div>
      <div class="fg"><label>Time</label><input type="time" id="f-time"></div>
    </div>
    <div class="fg-row">
      <div class="fg"><label>Follow-up Date</label><input type="date" id="f-followup"></div>
      <div class="fg"><label>Remind Before</label><select id="f-reminder"><option value="1">1 day</option><option value="3" selected>3 days</option><option value="7">7 days</option></select></div>
    </div>
    <div class="fg"><label>Notes</label><textarea id="f-notes" placeholder="Any extra detailsâ€¦"></textarea></div>
    <div class="divider"></div>
    <div class="fg"><label>Upload Photos (Gold / Documents)</label></div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('upload-input').click()">
      <span class="up-icon">ğŸ“·</span>Tap to upload photos of gold or documents
      <input type="file" id="upload-input" multiple accept="image/*" onchange="handleUpload(event)">
    </div>
    <div class="preview-row" id="preview-row"></div>
  </div>
  <div class="form-save-btn">
    <button class="form-save-inner" id="save-btn" onclick="saveTransaction()">ğŸ’¾ Save & Send WhatsApp</button>
  </div>
</div>

<!-- WA SHEET -->
<div class="wa-sheet" id="wa-sheet">
  <div class="wa-inner">
    <div class="sheet-handle" style="margin:0 auto 8px"></div>
    <h3>ğŸ“² WhatsApp Verification</h3>
    <div class="wa-preview" id="wa-preview"></div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px;text-align:center" id="wa-to-label"></p>
    <div class="wa-action-row">
      <button class="big-btn big-btn-outline" onclick="closeWA()">Skip</button>
      <button class="big-btn big-btn-gold" id="wa-open-btn">Open WhatsApp ğŸ“±</button>
    </div>
  </div>
</div>

<!-- CLOSE DEAL SHEET -->
<div class="close-sheet" id="close-sheet">
  <div class="close-inner">
    <div class="sheet-handle" style="margin:0 auto 8px"></div>
    <h3>âœ… Mark as Closed</h3>
    <div class="close-detail-grid" id="close-grid"></div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;text-align:center">Both parties will receive a WhatsApp closure confirmation.</p>
    <div style="display:flex;gap:10px">
      <button class="big-btn big-btn-outline" onclick="document.getElementById('close-sheet').classList.remove('open')">Cancel</button>
      <button class="big-btn big-btn-green" id="close-confirm-btn">Confirm & Close</button>
    </div>
  </div>
</div>

<!-- PROFILE SHEET -->
<div class="profile-sheet" id="profile-sheet">
  <div class="profile-inner">
    <div class="sheet-handle" style="margin:0 auto 8px"></div>
    <h3>My Account</h3>
    <div class="profile-biz" id="profile-bizname">â€”</div>
    <div class="profile-email" id="profile-email">â€”</div>
    <button class="big-btn big-btn-outline" style="margin-bottom:10px" onclick="closeProfile()">Close</button>
    <button class="big-btn big-btn-red" onclick="signOut()">ğŸšª Sign Out</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://hmosqodxybuadstbozud.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhtb3Nxb2R4eWJ1YWRzdGJvenVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MjUzMTAsImV4cCI6MjA4NzIwMTMxMH0.HC32OD-YHjLgacF7zO0edimZ8VRmv1MO-zLVfTouU8E';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERIFICATION PAGE â€” runs when party clicks Accept/Dispute
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const params = new URLSearchParams(window.location.search);
  const txnId = params.get('txn');
  const action = params.get('action');
  if(!txnId || !action) return;
  const isAccept = action === 'accept';
  const TYPE_N = {gold_credit:'Gold Given on Credit',cash_loan:'Cash Loan (Mortgage)',gold_taken:'Gold Taken',wholesale:'Wholesale Deal'};

  async function showVerifyPage() {
    // Update wa_status in Supabase
    try {
      await sb.from('transactions').update({wa_status: isAccept?'confirmed':'disputed'}).eq('id', txnId);
    } catch(e) {}

    // Fetch transaction details to show
    let t = null;
    try {
      const {data} = await sb.from('transactions').select('*').eq('id', txnId).single();
      t = data;
    } catch(e){}

    document.open();
    document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><title>SONA â€” '+(isAccept?'Accepted':'Disputed')+'</title><link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"><style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:"DM Sans",sans-serif;background:#FAF7F0;min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:20px}.card{background:white;border-radius:24px;max-width:400px;width:100%;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.12)}.top{padding:32px 28px 24px;text-align:center;background:'+(isAccept?'#1A3A1A':'#3A1A1A')+'}.icon{font-size:56px;display:block;margin-bottom:12px}.title{font-family:"Cormorant Garamond",serif;font-size:28px;font-weight:700;color:'+(isAccept?'#69F0AE':'#FF8A80')+'}.sub{font-size:13px;color:rgba(255,255,255,.6);margin-top:6px}.body{padding:24px 28px}.row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}.item{background:#FFF8E8;border-radius:12px;padding:12px 14px}.item label{font-size:11px;color:#8A7A5A;text-transform:uppercase;display:block;margin-bottom:3px}.item span{font-family:"Cormorant Garamond",serif;font-size:20px;font-weight:700;color:#1A1208;display:block}.notice{background:'+(isAccept?'#E8F5E9':'#FFEBEE')+';border-radius:12px;padding:14px;font-size:14px;color:'+(isAccept?'#2E7D32':'#C62828')+';margin-top:16px;line-height:1.7;text-align:center}.footer{padding:20px 28px 28px;text-align:center;font-size:12px;color:#8A7A5A}</style></head><body><div class="card">'+
      (t?'<div class="top"><span class="icon">'+(isAccept?'âœ…':'âŒ')+'</span><div class="title">Transaction '+(isAccept?'Accepted':'Disputed')+'</div><div class="sub">'+t.party+' Â· '+new Date().toLocaleDateString('en-IN')+'</div></div><div class="body"><div class="row"><div class="item"><label>Type</label><span style="font-size:13px;font-family:DM Sans">'+(TYPE_N[t.type]||t.type)+'</span></div><div class="item"><label>Metal</label><span style="font-size:16px">'+(t.metal==='gold'?'ğŸ¥‡ Gold':'ğŸ¥ˆ Silver')+' '+(t.purity||'')+'</span></div></div><div class="row"><div class="item"><label>Weight</label><span>'+t.weight+'g</span></div><div class="item"><label>Amount</label><span>â‚¹'+Number(t.amount).toLocaleString('en-IN')+'</span></div></div><div class="notice">'+(isAccept?'âœ… You have <strong>accepted</strong> this transaction. This is recorded. The ledger owner has been notified.':'âŒ You have <strong>disputed</strong> this transaction. The ledger owner will contact you to resolve this.')+'</div></div><div class="footer">âœ¦ SONA Gold Ledger</div>'
      :'<div class="body" style="padding:40px;text-align:center"><span style="font-size:48px">ğŸ”</span><p style="color:#8A7A5A;margin-top:12px;line-height:1.6">Transaction not found.<br>Please contact the sender directly.</p></div>')
      +'</div></body></html>');
    document.close();
  }
  showVerifyPage();
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let transactions = [];
let currentUser = null;
let currentBusiness = null;
let uploadedImageUrls = [];
let currentFilter = 'all';
let closeTargetId = null;

const TYPE_NAMES = {gold_credit:'Gold Credit',cash_loan:'Cash Loan',gold_taken:'Gold Taken',wholesale:'Wholesale'};
const TYPE_CLS = {gold_credit:'badge-gold-credit',cash_loan:'badge-cash-loan',gold_taken:'badge-gold-taken',wholesale:'badge-wholesale'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLoading(v){ document.getElementById('loading-overlay').classList.toggle('hidden',!v); }

function toast(msg, type=''){
  const el = document.getElementById('toast');
  el.textContent = msg; el.className = 'toast show ' + type;
  setTimeout(()=>el.classList.remove('show'), 3000);
}

function showApp(){
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('main-app').style.display = 'flex';
  document.getElementById('fab-btn').style.display = 'flex';
  if(currentBusiness){
    document.getElementById('topbar-bizname').textContent = currentBusiness.business_name || 'Gold Ledger';
    document.getElementById('profile-bizname').textContent = currentBusiness.business_name || 'â€”';
  }
  document.getElementById('profile-email').textContent = currentUser?.email || 'â€”';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendOTP(){
  const email = document.getElementById('auth-email').value.trim();
  const err = document.getElementById('email-err');
  err.style.display = 'none';
  if(!email || !email.includes('@')){ err.textContent='Please enter a valid email.'; err.style.display='block'; return; }
  const btn = document.getElementById('send-otp-btn');
  btn.disabled = true; btn.textContent = 'Sendingâ€¦';
  showLoading(true);
  const {error} = await sb.auth.signInWithOtp({ email, options: { shouldCreateUser: true } });
  showLoading(false);
  btn.disabled = false; btn.textContent = 'Send Login Code â†’';
  if(error){ err.textContent = error.message; err.style.display='block'; return; }
  document.getElementById('otp-sent-to').textContent = `Code sent to ${email}. Check your inbox & spam folder.`;
  document.getElementById('auth-step-email').style.display = 'none';
  document.getElementById('auth-step-otp').style.display = 'block';
  setupOTPInputs();
}

function setupOTPInputs(){
  const boxes = document.querySelectorAll('.otp-box');
  boxes.forEach((box, i) => {
    box.value = '';
    box.addEventListener('input', ()=>{
      if(box.value.length === 1 && i < boxes.length-1) boxes[i+1].focus();
      if(getOTPValue().length === 6) verifyOTP();
    });
    box.addEventListener('keydown', e=>{
      if(e.key==='Backspace' && !box.value && i > 0) boxes[i-1].focus();
    });
  });
  boxes[0].focus();
}

function getOTPValue(){
  return [...document.querySelectorAll('.otp-box')].map(b=>b.value).join('');
}

async function verifyOTP(){
  const email = document.getElementById('auth-email').value.trim();
  const token = getOTPValue();
  const err = document.getElementById('otp-err');
  err.style.display = 'none';
  if(token.length !== 6){ err.textContent='Please enter the full 6-digit code.'; err.style.display='block'; return; }
  const btn = document.getElementById('verify-otp-btn');
  btn.disabled = true; btn.textContent = 'Verifyingâ€¦';
  showLoading(true);
  const {data, error} = await sb.auth.verifyOtp({ email, token, type:'email' });
  showLoading(false);
  btn.disabled = false; btn.textContent = 'Verify & Login';
  if(error){ err.textContent = 'Invalid or expired code. Please try again.'; err.style.display='block'; return; }
  currentUser = data.user;
  await checkBusiness();
}

async function checkBusiness(){
  showLoading(true);
  const {data} = await sb.from('businesses').select('*').eq('id', currentUser.id).single();
  showLoading(false);
  if(data){
    currentBusiness = data;
    await loadTransactions();
    showApp();
  } else {
    // New user â€” show business setup
    document.getElementById('auth-step-otp').style.display = 'none';
    document.getElementById('auth-step-setup').style.display = 'block';
  }
}

async function setupBusiness(){
  const bizname = document.getElementById('setup-bizname').value.trim();
  const ownername = document.getElementById('setup-ownername').value.trim();
  const phone = document.getElementById('setup-phone').value.trim();
  const err = document.getElementById('setup-err');
  err.style.display = 'none';
  if(!bizname){ err.textContent='Please enter your business name.'; err.style.display='block'; return; }
  showLoading(true);
  const {data, error} = await sb.from('businesses').insert({
    id: currentUser.id,
    business_name: bizname,
    owner_name: ownername,
    phone: phone
  }).select().single();
  showLoading(false);
  if(error){ err.textContent = error.message; err.style.display='block'; return; }
  currentBusiness = data;
  transactions = [];
  showApp();
  renderAll();
}

function backToEmail(){
  document.getElementById('auth-step-otp').style.display = 'none';
  document.getElementById('auth-step-email').style.display = 'block';
}

async function signOut(){
  showLoading(true);
  await sb.auth.signOut();
  showLoading(false);
  currentUser = null; currentBusiness = null; transactions = [];
  document.getElementById('profile-sheet').classList.remove('open');
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('fab-btn').style.display = 'none';
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('auth-step-email').style.display = 'block';
  document.getElementById('auth-step-otp').style.display = 'none';
  document.getElementById('auth-step-setup').style.display = 'none';
  document.getElementById('auth-email').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA â€” SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTransactions(){
  document.getElementById('sync-bar').classList.add('show');
  const {data, error} = await sb.from('transactions')
    .select('*')
    .eq('business_id', currentUser.id)
    .order('created_at', {ascending: false});
  document.getElementById('sync-bar').classList.remove('show');
  if(error){ toast('Error loading data: '+error.message, 'error'); return; }
  transactions = data || [];
  renderAll();
}

async function saveToSupabase(t){
  const {error} = await sb.from('transactions').insert({
    id: t.id,
    business_id: currentUser.id,
    party: t.party,
    phone: t.phone,
    type: t.type,
    metal: t.metal,
    weight: t.weight,
    rate: t.rate,
    amount: t.amount,
    purity: t.purity,
    date: t.date,
    time: t.time,
    followup: t.followup || null,
    reminder: t.reminder,
    notes: t.notes,
    status: t.status,
    wa_status: t.waStatus,
    images: t.images
  });
  if(error) throw error;
}

async function updateInSupabase(id, updates){
  const {error} = await sb.from('transactions').update(updates).eq('id', id);
  if(error) throw error;
}

async function deleteFromSupabase(id){
  const {error} = await sb.from('transactions').delete().eq('id', id);
  if(error) throw error;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE UPLOAD TO SUPABASE STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uploadImage(file, txnId){
  const ext = file.name.split('.').pop();
  const path = `${currentUser.id}/${txnId}/${Date.now()}.${ext}`;
  const {data, error} = await sb.storage.from('transaction-images').upload(path, file, {cacheControl:'3600', upsert:false});
  if(error) throw error;
  const {data: urlData} = sb.storage.from('transaction-images').getPublicUrl(path);
  return urlData.publicUrl;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  const tab = document.getElementById('tab-'+id);
  if(tab) tab.classList.add('active');
  document.getElementById('scroll-area').scrollTop = 0;
  if(id==='reminders') renderReminders();
  if(id==='parties') renderParties();
  if(id==='txns') renderTxnPage();
  if(id==='home') renderHome();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function typeBadge(type){ return `<span class="txn-type-badge ${TYPE_CLS[type]||''}">${TYPE_NAMES[type]||type}</span>`; }

function statusInfo(t){
  if(t.status==='closed') return {label:'âœ“ Closed',cls:'pill-closed',bar:'txn-closed-bar'};
  if(!t.followup) return {label:'Open',cls:'pill-open',bar:'txn-open-bar'};
  const today=new Date();today.setHours(0,0,0,0);
  if(new Date(t.followup)<today) return {label:'Overdue âš ï¸',cls:'pill-overdue',bar:'txn-overdue-bar'};
  return {label:'Open',cls:'pill-open',bar:'txn-open-bar'};
}

function fmtAmt(n){ return 'â‚¹'+Number(n).toLocaleString('en-IN'); }

function txnCard(t){
  const si = statusInfo(t);
  const waS = t.wa_status || t.waStatus || 'pending';
  return `<div class="txn-card" onclick="openDetail('${t.id}')">
    <div class="${si.bar}"></div>
    <div class="txn-card-top">
      <div><div class="txn-party">${t.party}</div><div class="txn-phone">ğŸ“ ${t.phone}</div></div>
      ${typeBadge(t.type)}
    </div>
    <div class="txn-card-mid">
      <div class="txn-metric"><label>${t.metal==='gold'?'ğŸ¥‡':'ğŸ¥ˆ'} Weight</label><span>${t.weight}g</span></div>
      <div class="txn-metric"><label>ğŸ’° Amount</label><span class="amt">${fmtAmt(t.amount)}</span></div>
      <div class="txn-metric"><label>ğŸ“ˆ Rate/10g</label><span style="font-size:17px">â‚¹${(t.rate/1000).toFixed(1)}k</span></div>
    </div>
    <div class="txn-card-bot">
      <div class="txn-date-row"><strong>${t.date}</strong> ${t.time||''}${t.followup?`<br><span style="font-size:11px">Due: ${t.followup}</span>`:''}</div>
      <span class="status-pill ${si.cls}">${si.label}</span>
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  const open = transactions.filter(t=>t.status==='open');
  const goldOut = open.filter(t=>['gold_credit','gold_taken'].includes(t.type)&&t.metal==='gold').reduce((s,t)=>s+Number(t.weight),0);
  const cashOut = open.filter(t=>t.type==='cash_loan').reduce((s,t)=>s+Number(t.amount),0);
  const parties = new Set(transactions.map(t=>t.phone)).size;
  document.getElementById('s-gold').textContent = goldOut.toFixed(1)+'g';
  document.getElementById('s-cash').textContent = cashOut>=1e5?'â‚¹'+(cashOut/1e5).toFixed(1)+'L':fmtAmt(cashOut);
  document.getElementById('s-open').textContent = open.length;
  document.getElementById('s-parties').textContent = parties;
  const today=new Date();today.setHours(0,0,0,0);
  const week=new Date(today);week.setDate(week.getDate()+7);
  const overdue=open.filter(t=>t.followup&&new Date(t.followup)<today).length;
  const upcoming=open.filter(t=>{if(!t.followup)return false;const d=new Date(t.followup);return d>=today&&d<=week;}).length;
  document.getElementById('alert-overdue-banner').style.display=overdue?'':'none';
  document.getElementById('alert-upcoming-banner').style.display=upcoming?'':'none';
  document.getElementById('a-overdue').textContent=overdue;
  document.getElementById('a-upcoming').textContent=upcoming;
  const total=overdue+upcoming;
  document.getElementById('tab-badge').textContent=total;
  document.getElementById('tab-badge').style.display=total?'':'none';
  document.getElementById('notif-dot').style.display=total?'':'none';
  const list=document.getElementById('home-txn-list');
  const recent=transactions.slice(0,8);
  list.innerHTML=recent.length?recent.map(txnCard).join(''):`<div class="empty-state"><span class="empty-icon">âš–ï¸</span><p>No transactions yet.<br>Tap ï¼‹ to add your first entry.</p></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEDGER PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTxnPage(){
  const q=(document.getElementById('search-input').value||'').toLowerCase();
  const today=new Date();today.setHours(0,0,0,0);
  let data=transactions.filter(t=>{
    if(q&&!t.party.toLowerCase().includes(q)&&!t.phone.includes(q)) return false;
    if(currentFilter==='all') return true;
    if(currentFilter==='open') return t.status==='open';
    if(currentFilter==='closed') return t.status==='closed';
    if(currentFilter==='overdue') return t.status==='open'&&t.followup&&new Date(t.followup)<today;
    return t.type===currentFilter;
  });
  const list=document.getElementById('txn-list');
  list.innerHTML=data.length?data.map(txnCard).join(''):`<div class="empty-state"><span class="empty-icon">ğŸ”</span><p>No transactions found.</p></div>`;
}

function setFilter(f,el){
  currentFilter=f;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderTxnPage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderReminders(){
  const today=new Date();today.setHours(0,0,0,0);
  const week=new Date(today);week.setDate(week.getDate()+7);
  const open=transactions.filter(t=>t.status==='open'&&t.followup);
  const overdue=open.filter(t=>new Date(t.followup)<today).sort((a,b)=>new Date(a.followup)-new Date(b.followup));
  const todayDue=open.filter(t=>new Date(t.followup).getTime()===today.getTime());
  const upcoming=open.filter(t=>{const d=new Date(t.followup);return d>today&&d<=week;}).sort((a,b)=>new Date(a.followup)-new Date(b.followup));
  let html='';
  if(overdue.length){html+=`<div class="reminder-group-label red">âš ï¸ Overdue (${overdue.length})</div>`;html+=overdue.map(t=>remCard(t,'overdue')).join('');}
  if(todayDue.length){html+=`<div class="reminder-group-label amber">ğŸ”” Due Today (${todayDue.length})</div>`;html+=todayDue.map(t=>remCard(t,'today')).join('');}
  if(upcoming.length){html+=`<div class="reminder-group-label mgreen">ğŸ“… Upcoming (${upcoming.length})</div>`;html+=upcoming.map(t=>remCard(t,'upcoming')).join('');}
  if(!html)html=`<div class="empty-state"><span class="empty-icon">âœ…</span><p>All caught up!<br>No pending follow-ups.</p></div>`;
  document.getElementById('reminders-content').innerHTML=html;
}

function remCard(t,kind){
  const today=new Date();today.setHours(0,0,0,0);
  const d=new Date(t.followup);
  const diff=Math.round((d-today)/864e5);
  const dateStr=diff<0?`${Math.abs(diff)}d overdue`:diff===0?'Today':`In ${diff}d`;
  const icon=kind==='overdue'?'âš ï¸':kind==='today'?'ğŸ””':'ğŸ“…';
  const dateCls=kind==='overdue'?'red':kind==='today'?'amber':'mgreen';
  const cardCls=kind==='overdue'?'rem-overdue':kind==='today'?'rem-today':'';
  return `<div class="reminder-card ${cardCls}" onclick="openDetail('${t.id}')">
    <div class="rem-icon">${icon}</div>
    <div class="rem-info"><div class="rem-name">${t.party}</div><div class="rem-sub">${TYPE_NAMES[t.type]} Â· ${t.weight}g Â· ${fmtAmt(t.amount)}</div></div>
    <div class="rem-date ${dateCls}">${dateStr}</div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParties(){
  const map={};
  transactions.forEach(t=>{if(!map[t.phone])map[t.phone]={name:t.party,phone:t.phone,txns:[]};map[t.phone].txns.push(t);});
  const list=document.getElementById('parties-list');
  const parties=Object.values(map);
  if(!parties.length){list.innerHTML=`<div class="empty-state"><span class="empty-icon">ğŸ¤</span><p>No parties yet.</p></div>`;return;}
  list.innerHTML=parties.map(p=>{
    const open=p.txns.filter(t=>t.status==='open').length;
    const gold=p.txns.reduce((s,t)=>s+(t.metal==='gold'?Number(t.weight):0),0);
    const cash=p.txns.filter(t=>t.type==='cash_loan').reduce((s,t)=>s+Number(t.amount),0);
    return `<div class="party-card" onclick="filterByParty('${p.phone}')">
      <div class="party-card-top">
        <div class="party-avatar">${p.name.charAt(0).toUpperCase()}</div>
        <div><div class="party-name">${p.name}</div><div class="party-phone">ğŸ“ ${p.phone}</div></div>
      </div>
      <div class="party-stats">
        <div class="p-stat"><label>Open Deals</label><span>${open}</span></div>
        <div class="p-stat"><label>Gold (g)</label><span>${gold.toFixed(1)}</span></div>
        <div class="p-stat"><label>Cash Lent</label><span>${cash>=1e5?(cash/1e5).toFixed(1)+'L':cash>=1000?'â‚¹'+(cash/1000).toFixed(0)+'k':fmtAmt(cash)}</span></div>
      </div>
    </div>`;
  }).join('');
}

function filterByParty(phone){
  document.getElementById('search-input').value=phone;
  currentFilter='all';
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('.chip[data-f="all"]').classList.add('active');
  showPage('txns');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(id){
  const t=transactions.find(x=>x.id===id);
  if(!t) return;
  document.getElementById('ds-party').textContent=t.party;
  document.getElementById('ds-phone').textContent='ğŸ“ '+t.phone;
  const si=statusInfo(t);
  const waS = t.wa_status||t.waStatus||'pending';
  document.getElementById('ds-badges').innerHTML=typeBadge(t.type)+`<span class="status-pill ${si.cls}" style="font-size:12px;padding:4px 12px">${si.label}</span>`;
  const today=new Date();today.setHours(0,0,0,0);
  let followupStr='â€”';
  if(t.followup){
    const d=new Date(t.followup);const diff=Math.round((d-today)/864e5);
    const tag=diff<0?`<span style="color:var(--red)"> (${Math.abs(diff)}d overdue)</span>`:diff===0?`<span style="color:var(--orange)"> (Today!)</span>`:`<span style="color:var(--green)"> (${diff}d away)</span>`;
    followupStr=t.followup+tag;
  }
  const waClass = waS==='confirmed'?'wa-confirmed':waS==='disputed'?'wa-disputed':'wa-pending';
  const waText = waS==='confirmed'?'âœ… Party confirmed transaction':waS==='disputed'?'âŒ Party disputed â€” contact them!':'â³ Awaiting party confirmation';
  const imgs = t.images || [];
  document.getElementById('ds-body').innerHTML=`
    <div class="detail-row">
      <div class="d-item"><label>Metal & Purity</label><span>${t.metal==='gold'?'ğŸ¥‡ Gold':'ğŸ¥ˆ Silver'} ${t.purity||''}</span></div>
      <div class="d-item"><label>Date & Time</label><span style="font-size:14px">${t.date} ${t.time||''}</span></div>
    </div>
    <div class="detail-row">
      <div class="d-item"><label>Weight</label><span class="big">${t.weight}g</span></div>
      <div class="d-item"><label>Amount</label><span class="big">${fmtAmt(t.amount)}</span></div>
    </div>
    <div class="detail-row">
      <div class="d-item"><label>Rate /10g</label><span>${fmtAmt(t.rate)}</span></div>
      <div class="d-item"><label>Follow-up Due</label><span style="font-size:13px">${followupStr}</span></div>
    </div>
    ${t.notes?`<div class="notes-box">ğŸ“ ${t.notes}</div>`:''}
    <div class="wa-row ${waClass}"><span class="wa-icon">${waS==='confirmed'?'âœ…':waS==='disputed'?'âŒ':'â³'}</span><span>${waText}</span></div>
    ${imgs.length?`<div class="photo-row">${imgs.map(i=>`<img class="photo-thumb" src="${i}" onclick="window.open('${i}','_blank')">`).join('')}</div>`:''}
  `;
  document.getElementById('ds-actions').innerHTML=`
    ${t.status==='open'?`<button class="big-btn big-btn-green" onclick="openCloseSheet('${t.id}')">âœ… Mark as Closed</button>`:''}
    <button class="big-btn big-btn-gold" onclick="resendWA('${t.id}')">ğŸ“² Resend WhatsApp</button>
    <button class="big-btn big-btn-red" onclick="delTxn('${t.id}')">ğŸ—‘ï¸ Delete Entry</button>
  `;
  document.getElementById('sheet-overlay').classList.add('open');
  document.getElementById('bottom-sheet').classList.add('open');
}

function closeSheet(){
  document.getElementById('sheet-overlay').classList.remove('open');
  document.getElementById('bottom-sheet').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingFiles = [];

function openForm(){
  pendingFiles = []; uploadedImageUrls = [];
  document.getElementById('preview-row').innerHTML='';
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-time').value=new Date().toTimeString().slice(0,5);
  ['f-party','f-phone','f-purity','f-weight','f-rate','f-amount','f-followup','f-notes'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('f-type').value='';
  document.getElementById('calc-chip').textContent='Amount: â€”';
  document.getElementById('upload-zone').classList.remove('uploading');
  const parties=[...new Set(transactions.map(t=>t.party))];
  document.getElementById('party-list').innerHTML=parties.map(p=>`<option value="${p}">`).join('');
  document.getElementById('form-sheet').classList.add('open');
}

function closeForm(){ document.getElementById('form-sheet').classList.remove('open'); }

function calcAmt(){
  const w=parseFloat(document.getElementById('f-weight').value)||0;
  const r=parseFloat(document.getElementById('f-rate').value)||0;
  if(w&&r){const amt=Math.round(w*r/10);document.getElementById('f-amount').value=amt;document.getElementById('calc-chip').textContent=`Calculated: â‚¹${amt.toLocaleString('en-IN')}`;}
  else document.getElementById('calc-chip').textContent='Amount: â€”';
}

function handleUpload(e){
  Array.from(e.target.files).forEach(file=>{
    pendingFiles.push(file);
    const r=new FileReader();
    r.onload=ev=>{
      const img=document.createElement('img');
      img.src=ev.target.result; img.className='prev-img';
      document.getElementById('preview-row').appendChild(img);
    };
    r.readAsDataURL(file);
  });
}

async function saveTransaction(){
  const party=document.getElementById('f-party').value.trim();
  const phone=document.getElementById('f-phone').value.trim();
  const type=document.getElementById('f-type').value;
  const weight=parseFloat(document.getElementById('f-weight').value);
  const rate=parseFloat(document.getElementById('f-rate').value);
  if(!party||!phone||!type||!weight||!rate){toast('Please fill: Party Name, Phone, Type, Weight, Rate','error');return;}
  const amount=parseFloat(document.getElementById('f-amount').value)||Math.round(weight*rate/10);
  const txnId='T'+Date.now();
  const btn=document.getElementById('save-btn');
  btn.disabled=true; btn.textContent='Savingâ€¦';

  // Upload images first
  const imageUrls=[];
  if(pendingFiles.length){
    document.getElementById('upload-zone').classList.add('uploading');
    btn.textContent='Uploading photosâ€¦';
    for(const file of pendingFiles){
      try{ const url=await uploadImage(file, txnId); imageUrls.push(url); }
      catch(e){ toast('Photo upload failed: '+e.message,'error'); }
    }
    document.getElementById('upload-zone').classList.remove('uploading');
  }

  const t={
    id:txnId, party, phone, type,
    metal:document.getElementById('f-metal').value,
    weight, rate, amount,
    purity:document.getElementById('f-purity').value,
    date:document.getElementById('f-date').value,
    time:document.getElementById('f-time').value,
    followup:document.getElementById('f-followup').value||null,
    reminder:parseInt(document.getElementById('f-reminder').value),
    notes:document.getElementById('f-notes').value,
    status:'open', waStatus:'pending', wa_status:'pending',
    images:imageUrls, createdAt:Date.now()
  };

  btn.textContent='Saving to cloudâ€¦';
  try{
    await saveToSupabase(t);
    transactions.unshift(t);
    renderAll();
    closeForm();
    toast('Transaction saved! âœ…','success');
    showWASheet(t);
  } catch(e){
    toast('Save failed: '+e.message,'error');
  }
  btn.disabled=false; btn.textContent='ğŸ’¾ Save & Send WhatsApp';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getBaseUrl(){
  const loc=window.location;
  if(!loc.origin||loc.origin==='null'||loc.href.indexOf('srcdoc')>-1||loc.href.indexOf('blob:')>-1){
    return localStorage.getItem('sona_deploy_url')||'https://swapnil1995biraje-del.github.io/Sona';
  }
  const url = loc.origin+loc.pathname.replace(/\/$/,'');
  localStorage.setItem('sona_deploy_url', url);
  return url;
}

function buildMsg(t){
  const base=getBaseUrl();
  const acceptLink=`${base}?txn=${t.id}&action=accept`;
  const disputeLink=`${base}?txn=${t.id}&action=dispute`;
  const biz = currentBusiness?.business_name || 'AB GOLD';
  return `ğŸ”” *${biz} â€” Transaction Confirmation*\n\nDear *${t.party}*,\n\nA transaction has been recorded in your name:\n\n*Type:* ${TYPE_NAMES[t.type]}\n*Metal:* ${t.metal==='gold'?'Gold ğŸ¥‡':'Silver ğŸ¥ˆ'} (${t.purity||'â€”'})\n*Weight:* ${t.weight}g\n*Rate:* â‚¹${Number(t.rate).toLocaleString('en-IN')}/10g\n*Amount:* â‚¹${Number(t.amount).toLocaleString('en-IN')}\n*Date:* ${t.date} ${t.time||''}\n${t.followup?`*Due Date:* ${t.followup}\n`:''}\nPlease confirm this transaction:\n\nâœ… *ACCEPT:*\n${acceptLink}\n\nâŒ *DISPUTE:*\n${disputeLink}\n\nâ€” ${biz}`;
}

function showWASheet(t){
  const msg=buildMsg(t);
  document.getElementById('wa-preview').textContent=msg;
  document.getElementById('wa-to-label').textContent=`Message to: ${t.phone}`;
  const url=`https://wa.me/91${t.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
  document.getElementById('wa-open-btn').onclick=async()=>{
    window.open(url,'_blank');
    // Update wa_status to pending
    try{ await updateInSupabase(t.id,{wa_status:'pending'}); t.wa_status='pending'; }catch(e){}
    closeWA();
  };
  document.getElementById('wa-sheet').classList.add('open');
}

function closeWA(){ document.getElementById('wa-sheet').classList.remove('open'); }
function resendWA(id){ const t=transactions.find(x=>x.id===id); if(t){closeSheet();setTimeout(()=>showWASheet(t),250);} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOSE DEAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCloseSheet(id){
  const t=transactions.find(x=>x.id===id);if(!t)return;
  closeTargetId=id;
  document.getElementById('close-grid').innerHTML=`
    <div class="c-item"><label>Party</label><span style="font-size:16px;font-family:'DM Sans'">${t.party}</span></div>
    <div class="c-item"><label>Phone</label><span style="font-size:14px;font-family:'DM Sans'">${t.phone}</span></div>
    <div class="c-item"><label>Weight</label><span>${t.weight}g</span></div>
    <div class="c-item"><label>Amount</label><span>${fmtAmt(t.amount)}</span></div>`;
  document.getElementById('close-confirm-btn').onclick=confirmClose;
  closeSheet();setTimeout(()=>document.getElementById('close-sheet').classList.add('open'),250);
}

async function confirmClose(){
  const t=transactions.find(x=>x.id===closeTargetId);if(!t)return;
  showLoading(true);
  try{
    await updateInSupabase(t.id,{status:'closed'});
    t.status='closed';
    renderAll();
    document.getElementById('close-sheet').classList.remove('open');
    toast('Deal closed successfully âœ…','success');
    const biz = currentBusiness?.business_name||'AB GOLD';
    const msg=`âœ… *${biz} â€” Transaction CLOSED*\n\nDear *${t.party}*,\n\nYour transaction is now fulfilled and closed.\n\n*Weight:* ${t.weight}g\n*Amount:* â‚¹${Number(t.amount).toLocaleString('en-IN')}\n*Closed:* ${new Date().toLocaleDateString('en-IN')}\n\nThank you!\nâ€” ${biz}`;
    const url=`https://wa.me/91${t.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`;
    showLoading(false);
    if(confirm('Send closure WhatsApp to '+t.party+'?')) window.open(url,'_blank');
  }catch(e){
    showLoading(false);
    toast('Error: '+e.message,'error');
  }
}

async function delTxn(id){
  if(!confirm('Delete this transaction? This cannot be undone.'))return;
  showLoading(true);
  try{
    await deleteFromSupabase(id);
    transactions=transactions.filter(x=>x.id!==id);
    closeSheet(); renderAll();
    toast('Transaction deleted','success');
  }catch(e){ toast('Error: '+e.message,'error'); }
  showLoading(false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openProfile(){ document.getElementById('profile-sheet').classList.add('open'); }
function closeProfile(){ document.getElementById('profile-sheet').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderHome();
  if(document.getElementById('page-txns').classList.contains('active')) renderTxnPage();
  if(document.getElementById('page-reminders').classList.contains('active')) renderReminders();
  if(document.getElementById('page-parties').classList.contains('active')) renderParties();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Check existing session
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function init(){
  showLoading(true);

  // Check for verification link first
  const params=new URLSearchParams(window.location.search);
  if(params.get('txn') && params.get('action')){ showLoading(false); return; }

  const {data:{session}} = await sb.auth.getSession();
  if(session){
    currentUser = session.user;
    const {data} = await sb.from('businesses').select('*').eq('id', currentUser.id).single();
    if(data){
      currentBusiness = data;
      await loadTransactions();
      showApp();
    } else {
      document.getElementById('auth-step-otp').style.display='none';
      document.getElementById('auth-step-setup').style.display='block';
      document.getElementById('auth-screen').classList.remove('hidden');
    }
  }
  showLoading(false);

  // Listen for auth state changes
  sb.auth.onAuthStateChange(async(event, session)=>{
    if(event==='SIGNED_IN' && session){
      currentUser=session.user;
    }
  });
})();
</script>
</body>
</html>
